<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Jua&family=Poor+Story&display=swap');
  </style>
  <link href="../css/boardPage.css" rel="stylesheet" />
</head>

<body>
  <header>
    <div class="mytitle">
      <div>
        <h3 class="titleName">6사시미</h3>
      </div>
    </div>
    <div>
      <label>
        <h3 id="boardName">boardName</h3>
      </label>
      <button type="button" class="btn btn-info infoBtn" onclick="userInfo()">Info</button>
      <label>
        <h3 id="boardDesc">boardContent</h3>
      </label>
    </div>
  </header>
  <main>
    <div class="modal" id="modalNotAdmin">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
              onclick="closeModal()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 row">
              <label for="nickname" class="col-sm-2 col-form-label">nickname</label>
              <div class="col-sm-10">
                <input type="text" readonly class="form-control-plaintext" id="nickname" value="nickname">
              </div>
            </div>
            <div class="mb-3 row">
              <label for="nickname" class="col-sm-2 col-form-label">참여자</label>
            </div>
            <div class="mb-3 row members">
              <div class="col-sm-10 member">
                <img src="../image/cat.jpg" style="width: 100px; height: 100px; border-radius: 50px;" />
                <input type="text" readonly class="form-control-plaintext" id="nickname" value="nickname1">
              </div>
              <div class="col-sm-10 member">
                <img src="../image/cat.jpg" style="width: 100px; height: 100px; border-radius: 50px;" />
                <input type="text" readonly class="form-control-plaintext" id="nickname" value="nickname1">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
              onclick="closeModal()">Close</button>
            <button type="button" class="btn btn-primary" onclick="myPage()">my Page</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="modalAdmin">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
              onclick="closeAdminModal()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 row">
              <label for="nickname" class="col-sm-2 col-form-label">nickname</label>
              <div class="col-sm-10">
                <input type="text" readonly class="form-control-plaintext" id="nickname" value="nickname">
              </div>
            </div>
            <div class="mb-3 row">
              <button type="button" class="btn btn-light" onclick="memberBoardCheck()">참여자</button>
            </div>
            <div class="mb-3 row members">
              <div class="col-sm-10 member">
                <img src="../image/cat.jpg" style="width: 100px; height: 100px; border-radius: 50px;" />
                <input type="text" readonly class="form-control-plaintext" id="nickname" value="nickname1">
              </div>
              <div class="col-sm-10 member">
                <img src="../image/cat.jpg" style="width: 100px; height: 100px; border-radius: 50px;" />
                <input type="text" readonly class="form-control-plaintext" id="nickname" value="nickname1">
              </div>
              <div class="col-sm-10">
                <label>email</label>
                <input type="email" class="form-control" id="inviteEmail">
                <button type="button" class="btn btn-secondary" style="margin-top: 3%;">member invite</button>
              </div>
              <div class="mb-3 row backgroundColor">
                <label for="backgroundColor" class="col-sm-2 col-form-label">색상</label>
                <!-- 색상 리스트자리 -->
                <input type="color" style="width: 200px; margin: 10px auto auto auto;" class="form-control"
                  id="backgroundColor">
                <button type="button" class="btn btn-info"
                  style="width: 100px; margin: 10px auto auto auto;">저장</button>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                onclick="closeAdminModal()">Close</button>
              <button type="button" class="btn btn-primary" onclick="myPage()">my Page</button>
              <button type="button" class="btn btn-danger">보드 삭제</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal" id="modalColumnCreate">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Column create</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                onclick="closeColumnModal()"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3 row">
                <label for="columnName" class="col-sm-2 col-form-label">name</label>
                <div class="col-sm-10">
                  <input type="text" class="form-control" id="columnName">
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                onclick="closeColumnModal()">Close</button>
              <button type="button" class="btn btn-primary" id="createColumnBtn">column 생성</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal" id="modalCardCreate">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Card create</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                onclick="closeCardModal()"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3 row">
                <label for="cardTitle" class="col-sm-2 col-form-label">제목</label>
                <div class="col-sm-10">
                  <input type="text" class="form-control" id="cardTitle">
                </div>
              </div>
              <div class="mb-3 row">
                <label for="cardContent" class="col-sm-2 col-form-label">설명</label>
                <div class="col-sm-10">
                  <textarea class="form-control" id="cardContent" rows="3"></textarea>
                </div>
              </div>
              <div class="mb-3 row">
                <label for="cardColor" class="col-sm-2 col-form-label">색상</label>
                <!-- 색상 리스트자리 -->
                <input type="color" class="form-control" id="cardColor">
              </div>
              <div class="mb-3 row">
                <label for="cardDate" class="col-sm-2 col-form-label">마감일자</label>
                <!-- 마감일자 자리 아래 사이트 참고하려고 함-->
                <!-- https://programmer93.tistory.com/5#google_vignette -->
                <input type="date" class="form-control" id="expiredDate">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                onclick="closeCardModal()">Close</button>
              <button type="button" class="btn btn-primary" id="createCardBtn">생성</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal" id="modalCardGet">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Card Name</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                onclick="closeCardGetModal()"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3 row">
                <label for="cardTitle" class="col-sm-2 col-form-label">제목</label>
                <div class="col-sm-10">
                  <input type="text" readonly class="form-control-plaintext" id="cardTitle" value="cardName1">
                </div>
              </div>
              <div class="mb-3 row">
                <label for="cardContent" class="col-sm-2 col-form-label">설명</label>
                <div class="col-sm-10">
                  <textarea class="form-control-plaintext" readonly id="cardContent" rows="3"
                    style="min-height: 50px;">content</textarea>
                </div>
              </div>
              <div class="mb-3 row">
                <label for="cardColor" class="col-sm-2 col-form-label">색상</label>
                <input type="text" class="form-control-plaintext" readonly id="cardgetColor" value="#000000">
              </div>
              <div class="mb-3 row">
                <label for="cardDate" class="col-sm-2 col-form-label">마감일자</label>
                <!-- 마감일자 자리 아래 사이트 참고하려고 함-->
                <!-- https://programmer93.tistory.com/5#google_vignette -->
                <input type="date" class="form-control-plaintext" readonly id="expiredDate" value="2023-08-11">
              </div>
              <div class="mb-3 row">
                <button type="button" class="btn btn-light" onclick="memberCheck()">참여한 멤버 확인</button>
              </div>
              <div class="mb-3 row cardMembers">
                <div class="col-sm-10 cardMember">
                  <img src="../image/cat.jpg" style="width: 50px; height: 50px; border-radius: 50px;" />
                  <input type="text" readonly class="form-control-plaintext" id="CardNickname" value="nickname1">
                </div>
                <div class="col-sm-10 cardMember">
                  <img src="../image/cat.jpg" style="width: 50px; height: 50px; border-radius: 50px;" />
                  <input type="text" readonly class="form-control-plaintext" id="CardNickname" value="nickname1">
                </div>
              </div>
              <div class="mb-3 row">
                <select class="form-select" style="width: auto;" id='search_type'>
                  <option value="none">선택해주세요</option>
                  <option value="email1">email1</option>
                  <option value="email2">email2</option>
                </select>
                <div class="col-sm-10">
                  <button type="button" class="btn btn-secondary">member +</button>
                </div>
              </div>
              <div>
                <button type="button" class="btn btn-secondary" onclick="commentBox()">댓글 작성</button>
              </div>
              <div id="commentBox">
                <div id="commentBody">
                  <div class="mb-3 row">
                    <label for="cardTitle" class="col-sm-2 col-form-label">nickname</label>
                  </div>
                  <div class="mb-3 row">
                    <label for="cardContent" class="col-sm-2 col-form-label">댓글작성란</label>
                    <div class="col-sm-10">
                      <textarea class="form-control" id="cardContent" rows="3" style="min-height: 50px;"></textarea>
                    </div>
                  </div>
                </div>
                <div>
                  <button type="button" class="btn btn-secondary" onclick="commentBox()">취소</button>
                  <button type="button" class="btn btn-secondary" id="commentSumbit">작성</button>
                </div>
              </div>
              <div class="mb-3 row">
                <label for="cardDate" class="col-sm-2 col-form-label">댓글</label>
                <div class="mb-3 row">
                  <label for="cardTitle" class="col-sm-2 col-form-label">nickname</label>
                </div>
                <div class="mb-3 row">
                  <div class="col-sm-10">
                    <textarea class="form-control-plaintext" readonly id="cardContent" rows="3"
                      style="min-height: 50px;">comment</textarea>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                onclick="closeCardGetModal()">Close</button>
              <button type="button" class="btn btn-primary" onclick="modalCardUpdate()">수정</button>
              <button type="button" class="btn btn-danger">삭제</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal" id="modalCardUpdate">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Card update</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                onclick="closeCardupdateModal()"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3 row">
                <label for="cardupdateTitle" class="col-sm-2 col-form-label">제목</label>
                <div class="col-sm-10">
                  <input type="text" class="form-control" id="cardupdateTitle" value="cardName">
                </div>
              </div>
              <div class="mb-3 row">
                <label for="cardupateContent" class="col-sm-2 col-form-label">설명</label>
                <div class="col-sm-10">
                  <textarea class="form-control" id="cardupateContent" rows="3">content</textarea>
                </div>
              </div>
              <div class="mb-3 row">
                <label for="cardupdateColor" class="col-sm-2 col-form-label">색상</label>
                <!-- 색상 리스트자리 -->
                <input type="color" class="form-control" id="cardupdateColor">
              </div>
              <div class="mb-3 row">
                <label for="cardupdateDate" class="col-sm-2 col-form-label">마감일자</label>
                <!-- 마감일자 자리 아래 사이트 참고하려고 함-->
                <!-- https://programmer93.tistory.com/5#google_vignette -->
                <input type="date" class="form-control" id="cardupdateDate" value="2023-08-11">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                onclick="closeCardupdateModal()">Close</button>
              <button type="button" class="btn btn-primary" id="cardUpdateBtn">수정</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="columnLists" class="d-flex flex-wrap justify-content-around columnBox">
      <div draggable="true" class="column m-9">
        <div>
          <input type="text" class="form-control" id="columnName" value="columnName1">
          <button id="mdfColumnBtn" type="button" class="btn btn-info">수정</button>
          <button id="dltColumnBtn" type="button" class="btn btn-danger">삭제</button>
        </div>
        <div draggable="true" class="cardBox">
          <div draggable="true" class="card" onclick="updateCard()">
            <input type="text" readonly class="form-control-plaintext" id="cardName" value="cardName1">
          </div>
        </div>
        <button type="button" class="btn btn-secondary" onclick="createCard()">card +</button>
      </div>
      <div draggable="true" class="column m-9">
        <div>
          <input type="text" class="form-control" id="columnName" value="columnName2">
          <button type="button" class="btn btn-info">수정</button>
          <button type="button" class="btn btn-danger">삭제</button>
        </div>
        <div draggable="true" class="cardBox">
        </div>
        <button type="button" class="btn btn-secondary" onclick="createCard()">card +</button>
      </div>
      <div draggable="true" class="column m-9">
        <div>
          <input type="text" class="form-control" id="columnName" value="columnName3">
          <button type="button" class="btn btn-info">수정</button>
          <button type="button" class="btn btn-danger">삭제</button>
        </div>
        <div draggable="true" class="cardBox">
          <div draggable="true" class="card" onclick="updateCard()">
            <input type="text" readonly class="form-control-plaintext" id="cardName" value="cardName2">
          </div>
          <div draggable="true" class="card" onclick="updateCard()">
            <input type="text" readonly class="form-control-plaintext" id="cardName" value="cardName3">
          </div>
        </div>
        <button type="button" class="btn btn-secondary" onclick="createCard()">card +</button>
      </div>
    </div>

    <div>
      <button type="button" class="btn btn-secondary columnBtn" onclick="columnCreate()">column +</button>
    </div>
  </main>
  <script>
    function userInfo() {
      //req?에 저장된 user정보를 가지고 db에서 board를 찾아 비교해서 사용
      //   if($('#modalNotAdmin').css('display') == 'none'){
      //     $('#modalNotAdmin').show();
      //   }
      if ($('#modalAdmin').css('display') == 'none') {
        $('#modalAdmin').show();
      }
    }

    function closeModal() {
      if ($('#modalNotAdmin').css('display') != 'none') {
        $('#modalNotAdmin').hide();
      }
    }

    function closeAdminModal() {
      if ($('#modalAdmin').css('display') != 'none') {
        $('#modalAdmin').hide();
      }
    }

    //마이페이지로 이동
    function myPage() {
      window.location.replace('./myPage.html');
    }

    //컬럼 생성 모달 온/오프
    function columnCreate() {
      if ($('#modalColumnCreate').css('display') == 'none') {
        $('#modalColumnCreate').show();
      }
    }

    function closeColumnModal() {
      if ($('#modalColumnCreate').css('display') != 'none') {
        $('#modalColumnCreate').hide();
      }
    }

    //카드 생성 모달 온/오프
    function createCard() {
      if ($('#modalCardCreate').css('display') == 'none') {
        $('#modalCardCreate').show();
      }
    }

    function closeCardModal() {
      if ($('#modalCardCreate').css('display') != 'none') {
        $('#modalCardCreate').hide();
      }
    }

    //카드 수정 모달 온/오프
    function updateCard() {
      if ($('#modalCardGet').css('display') == 'none') {
        $('#modalCardGet').show();
      }
    }

    function closeCardGetModal() {
      if ($('#modalCardGet').css('display') != 'none') {
        $('#modalCardGet').hide();
      }
    }

    //댓글 작성란 버튼
    function commentBox() {
      if ($('#commentBox').css('display') == 'none') {
        $('#commentBox').show();
      }
      else if ($('#commentBox').css('display') != 'none') {
        $('#commentBox').hide();
      }
    }

    //카드 수정 버튼 클릭시 온/오프
    function modalCardUpdate() {
      if ($('#modalCardUpdate').css('display') == 'none') {
        $('#modalCardUpdate').show();
        $('#modalCardGet').hide();
      }
    }

    function closeCardUpdateModal() {
      if ($('#modalCardUpdate').css('display') != 'none') {
        $('#modalCardUpdate').hide();
      }
    }

    //참여한 멤버 확인 버튼 온/오프
    function memberCheck() {
      if ($('.cardMembers').css('display') == 'none') {
        $('.cardMembers').show();
      }
      else if ($('.cardMembers').css('display') != 'none') {
        $('.cardMembers').hide();
      }
    }

    //보드에 참여한 멤버 확인
    function memberBoardCheck() {
      if ($('.members').css('display') == 'none') {
        $('.members').show();
      }
      else if ($('.members').css('display') != 'none') {
        $('.members').hide();
      }
    }
    //컬럼 드래그
    const columnDraggables = document.querySelectorAll('.column');
    const boardContainer = document.querySelectorAll(".columnBox");

    columnDraggables.forEach(draggable => {
      draggable.addEventListener("dragstart", () => {
        draggable.classList.add("dragging");
      });

      draggable.addEventListener("dragend", () => {
        draggable.classList.remove("dragging");
      });
    });
    boardContainer.forEach(container => {
      container.addEventListener("dragover", e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientX);
        const draggable = document.querySelector(".dragging");
        if (afterElement === undefined) {
          container.appendChild(draggable);
        } else {
          container.insertBefore(draggable, afterElement);
        }
      });
    });
    function getDragAfterElement(container, x) {
      const draggableElements = [
        ...container.querySelectorAll(".column:not(.dragging)"),
      ];

      return draggableElements.reduce(
        (closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = x - box.left - box.width / 2;

          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        },
        { offset: Number.NEGATIVE_INFINITY },
      ).element;
    }

    //카드 드래그
    const cardDraggables = document.querySelectorAll('.card');
    const cardContainer = document.querySelectorAll(".cardBox");

    cardDraggables.forEach(draggable => {
      draggable.addEventListener("dragstart", () => {
        draggable.classList.add("dragging2");
      });

      draggable.addEventListener("dragend", () => {
        draggable.classList.remove("dragging2");
      });
    });
    cardContainer.forEach(container => {
      container.addEventListener("dragover", e => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientX);
        const draggable = document.querySelector(".dragging2");
        if (afterElement === undefined) {
          container.appendChild(draggable);
        } else {
          container.insertBefore(draggable, afterElement);
        }
      });
    });
    function getDragAfterElement(container, x) {
      const draggableElements = [
        ...container.querySelectorAll(".column:not(.dragging2)"),
      ];

      return draggableElements.reduce(
        (closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = x - box.left - box.width / 2;

          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        },
        { offset: Number.NEGATIVE_INFINITY },
      ).element;
    }
    // 보드 정보
    const getBoardId = () => {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('boardId');
    };
    const getcolumnId = () => {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('columnId');
    };


    $(document).ready(() => {
      const boardId = getBoardId();
      const columnId = getcolumnId();
      getBoard(boardId);
      getColumns(boardId);
    });

    const getBoard = async (boardId) => {
      const response = await fetch(`/api/boards/${boardId}`);
      const boardInfo = await response.json();
      let { name, description } = boardInfo.data;
      const boardName = document.getElementById('boardName');
      const boardDesc = document.getElementById('boardDesc');
      boardName.innerText = `${name}`;
      boardDesc.innerText = `${description}`;
    };

    async function getColumns(boardId) {
      try {
        const response = await fetch(`/api/boards/${boardId}/columns`);
        const data = await response.json();
        const columns = data.columns;
        console.log(columns);

        const columnLists = document.getElementById('columnLists');
        columnLists.innerHTML = '';

        for (const column of columns) {
          const cards = await getCardsByColumnId(column.columnId);

          columnLists.innerHTML += `
        <div id="${column.columnId}" draggable="true" class="column m-9">
          <div>
            <input type="text" class="form-control" id="columnName" value="${column.name}">
            <button id="modifyColumnBtn" type="button" class="btn btn-info">수정</button>
            <button id="dltColumnBtn" type="button" class="btn btn-danger">삭제</button>
          </div>
          <div draggable="true" class="cardBox">
            ${cards}
          </div>
          <button type="button" class="btn btn-secondary" onclick="createCard(${column.columnId})">card +</button>
        </div>`;
        }
      } catch (error) {
        console.error(error);
      }
    }

    async function getCardsByColumnId(columnId) {
      const response = await fetch(`/api/columns/${columnId}/cards`);
      const data = await response.json();
      const cards = data.data;
      console.log(cards);
      return cards.map((card) => `
        <div draggable="true" class="card" onclick="updateCard(${columnId},${card.cardId})">
          <input type="text" readonly class="form-control-plaintext" id="cardName" value="${card.name}">
        </div>
      `
      ).join('');
    }



  </script>
</body>

</html>