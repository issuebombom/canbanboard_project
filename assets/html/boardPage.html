<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Jua&family=Poor+Story&display=swap');
  </style>
  <link href="../css/boardPage.css" rel="stylesheet" />
</head>

<body>
  <header>
    <div class="mytitle">
      <div>
        <h3 class="titleName"><a href="/main" style="text-decoration: none; color: inherit">6사시미</a></h3>
      </div>
    </div>
    <div>
      <label>
        <h3 id="boardName">boardName</h3>
      </label>
      <button type="button" class="btn btn-info infoBtn" onclick="userInfo()">Info</button>
      <label>
        <h3 id="boardDesc">boardContent</h3>
      </label>
    </div>
  </header>
  <main>
    <div class="modal" id="modalPforile">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
              onclick="closeModal()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 row">
              <label for="nickname" class="col-sm-2 col-form-label">nickname</label>
              <div class="col-sm-10" id="nickname">
                <input type="text" readonly class="form-control-plaintext" value="nickname">
              </div>
            </div>
            <div class="mb-3 row">
              <button type="button" class="btn btn-light" onclick="memberBoardCheck()">참여자</button>
            </div>
            <div class="mb-3 row members">
              <div class="col-sm-10 member">
                <img src="../image/cat.jpg" style="width: 100px; height: 100px; border-radius: 50px;" />
                <input type="text" readonly class="form-control-plaintext" value="nickname1">
              </div>
              <div class="col-sm-10 member">
                <img src="../image/cat.jpg" style="width: 100px; height: 100px; border-radius: 50px;" />
                <input type="text" readonly class="form-control-plaintext" value="nickname1">
              </div>
            </div>
            <!-- admin일경우 보이게 -->
            <div id="isAdminProfile">
              <div class="col-sm-10">
                <label>email</label>
                <input type="email" class="form-control" id="inviteEmail">
                <button type="button" class="btn btn-secondary" style="margin-top: 3%;" id="inviteEmailBtn">member
                  invite</button>
              </div>
              <div class="mb-3 row backgroundColor">
                <label for="backgroundColor" class="col-sm-2 col-form-label">색상</label>
                <!-- 색상 리스트자리 -->
                <input type="color" style="width: 200px; margin: 10px auto auto auto;" class="form-control"
                  id="backgroundColor">
                <button type="button" class="btn btn-info" style="width: 100px; margin: 10px auto auto auto;"
                  id="boardColorBtn">저장</button>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                onclick="closeModal()">Close</button>
              <button type="button" class="btn btn-primary" onclick="myPage()">my Page</button>
              <!-- admin일 경우 -->
              <div id="isAdminDeleteBtn">
                <button type="button" class="btn btn-danger" id="boardDeleteBtn">보드 삭제</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="modalColumnCreate">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Column create</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
              onclick="closeColumnModal()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 row">
              <label for="columnName" class="col-sm-2 col-form-label">name</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="columnName">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
              onclick="closeColumnModal()">Close</button>
            <button type="button" class="btn btn-primary" id="createColumnBtn">column 생성</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="modalCardCreate">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Card create</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
              onclick="closeCardModal()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 row">
              <label for="cardTitle" class="col-sm-2 col-form-label">제목</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="cardTitle">
              </div>
            </div>
            <div class="mb-3 row">
              <label for="cardContent" class="col-sm-2 col-form-label">설명</label>
              <div class="col-sm-10">
                <textarea class="form-control" id="cardContent" rows="3"></textarea>
              </div>
            </div>
            <div class="mb-3 row">
              <label for="cardColor" class="col-sm-2 col-form-label">색상</label>
              <!-- 색상 리스트자리 -->
              <input type="color" class="form-control" id="cardColor">
            </div>
            <div class="mb-3 row">
              <label for="cardDate" class="col-sm-2 col-form-label">마감일자</label>
              <!-- 마감일자 자리 아래 사이트 참고하려고 함-->
              <!-- https://programmer93.tistory.com/5#google_vignette -->
              <input type="date" class="form-control" id="expiredDate">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
              onclick="closeCardModal()">Close</button>
            <button type="button" class="btn btn-primary" id="createCardBtn">생성</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="modalCardGet">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <div id="cardName">
              <h5 class="modal-title">Card Name</h5>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
              onclick="closeCardGetModal()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 row">
              <label for="cardTitle" class="col-sm-2 col-form-label">제목</label>
              <div class="col-sm-10" id="cardGetTitle">
                <input type="text" readonly class="form-control-plaintext" value="cardName1">
              </div>
            </div>
            <div class="mb-3 row">
              <label for="cardContent" class="col-sm-2 col-form-label">설명</label>
              <div class="col-sm-10" id="cardgetContent">
                <textarea class="form-control-plaintext" readonly id="cardContent" rows="3"
                  style="min-height: 50px;">content</textarea>
              </div>
            </div>
            <div class="mb-3 row">
              <label for="cardColor" class="col-sm-2 col-form-label">색상</label>
              <input type="text" class="form-control-plaintext" readonly id="cardgetColor" value="#000000">
            </div>
            <div class="mb-3 row">
              <label for="cardDate" class="col-sm-2 col-form-label">마감일자</label>
              <!-- 마감일자 자리 아래 사이트 참고하려고 함-->
              <!-- https://programmer93.tistory.com/5#google_vignette -->
              <input type="date" class="form-control-plaintext" readonly id="expiredGetDate" value="2023-08-11">
            </div>
            <div class="mb-3 row">
              <button type="button" class="btn btn-light" onclick="memberCheck()">참여한 멤버 확인</button>
            </div>
            <div class="mb-3 row cardMembers">
              <div class="col-sm-10 cardMember">
                <img src="../image/cat.jpg" style="width: 50px; height: 50px; border-radius: 50px;" />
                <input type="text" readonly class="form-control-plaintext" id="CardNickname" value="nickname1">
              </div>
              <div class="col-sm-10 cardMember">
                <img src="../image/cat.jpg" style="width: 50px; height: 50px; border-radius: 50px;" />
                <input type="text" readonly class="form-control-plaintext" id="CardNickname" value="nickname1">
              </div>
            </div>
            <div class="mb-3 row">
              <select class="form-select" style="width: auto;" id='search_type'>
                <option value="none">선택해주세요</option>
                <option value="email1">email1</option>
                <option value="email2">email2</option>
              </select>
              <div class="col-sm-10">
                <button type="button" class="btn btn-secondary" id="memberAddBtn">member +</button>
              </div>
            </div>
            <div>
              <button type="button" class="btn btn-secondary" onclick="commentBox()">댓글 작성</button>
            </div>
            <div id="commentBox">
              <div id="commentBody">
                <div class="mb-3 row" id="commentNickname">
                  <label for="cardTitle" class="col-sm-2 col-form-label">nickname</label>
                </div>
                <div class="mb-3 row">
                  <label for="cardContent" class="col-sm-2 col-form-label">댓글작성란</label>
                  <div class="col-sm-10">
                    <textarea class="form-control" id="cardComment" rows="3" style="min-height: 50px;"></textarea>
                  </div>
                </div>
              </div>
              <div>
                <button type="button" class="btn btn-secondary" onclick="commentBox()">취소</button>
                <button type="button" class="btn btn-secondary" id="commentBtn">작성</button>
              </div>
            </div>
            <div class="mb-3 row">
              <label for="cardDate" class="col-sm-2 col-form-label">댓글</label>
              <div class="mb-3 row" id="commentGetBox">
                <label for="cardNickname" class="col-sm-2 col-form-label">nickname</label>
                <div class="col-sm-10">
                  <textarea class="form-control-plaintext" readonly id="cardContent" rows="3"
                    style="min-height: 50px;">comment</textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
              onclick="closeCardGetModal()">Close</button>
            <button type="button" class="btn btn-primary" id="modalCardUpdateBtn">수정</button>
            <button type="button" class="btn btn-danger" id="deleteCardBtn">삭제</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="modalCardUpdate">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Card update</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
              onclick="closeCardUpdateModal()"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 row">
              <label for="cardupdateTitle" class="col-sm-2 col-form-label">제목</label>
              <div class="col-sm-10">
                <input type="text" class="form-control" id="cardupdateTitle" value="cardName">
              </div>
            </div>
            <div class="mb-3 row">
              <label for="cardupdateContent" class="col-sm-2 col-form-label">설명</label>
              <div class="col-sm-10">
                <textarea class="form-control" id="cardupdateContent" rows="3">content</textarea>
              </div>
            </div>
            <div class="mb-3 row">
              <label for="cardupdateColor" class="col-sm-2 col-form-label">색상</label>
              <!-- 색상 리스트자리 -->
              <input type="color" class="form-control" id="cardupdateColor">
            </div>
            <div class="mb-3 row">
              <label for="cardupdateDate" class="col-sm-2 col-form-label">마감일자</label>
              <!-- 마감일자 자리 아래 사이트 참고하려고 함-->
              <!-- https://programmer93.tistory.com/5#google_vignette -->
              <input type="date" class="form-control" id="cardupdateDate" value="2023-08-11">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
              onclick="closeCardUpdateModal()">Close</button>
            <button type="button" class="btn btn-primary" id="cardUpdateBtn">수정</button>
          </div>
        </div>
      </div>
    </div>
    </div>
    <div id="columnLists" class="d-flex flex-wrap justify-content-around columnBox">
      <div draggable="true" class="column m-9">
        <div>
          <input type="text" class="form-control" id="columnName" value="columnName1">
          <button id="mdfColumnBtn" type="button" class="btn btn-info">수정</button>
          <button id="dltColumnBtn" type="button" class="btn btn-danger">삭제</button>
        </div>
        <div draggable="true" class="cardBox">
          <div draggable="true" class="card" onclick="updateCard()">
            <input type="text" readonly class="form-control-plaintext" id="cardName" value="cardName1">
          </div>
        </div>
        <button type="button" class="btn btn-secondary" onclick="createCard()">card +</button>
      </div>
      <div draggable="true" class="column m-9">
        <div>
          <input type="text" class="form-control" id="columnName" value="columnName2">
          <button type="button" class="btn btn-info">수정</button>
          <button type="button" class="btn btn-danger">삭제</button>
        </div>
        <div draggable="true" class="cardBox">
        </div>
        <button type="button" class="btn btn-secondary" onclick="createCard()">card +</button>
      </div>
      <div draggable="true" class="column m-9">
        <div>
          <input type="text" class="form-control" id="columnName" value="columnName3">
          <button type="button" class="btn btn-info">수정</button>
          <button type="button" class="btn btn-danger">삭제</button>
        </div>
        <div draggable="true" class="cardBox">
          <div draggable="true" class="card" onclick="updateCard()">
            <input type="text" readonly class="form-control-plaintext" id="cardName" value="cardName2">
          </div>
          <div draggable="true" class="card" onclick="updateCard()">
            <input type="text" readonly class="form-control-plaintext" id="cardName" value="cardName3">
          </div>
        </div>
        <button type="button" class="btn btn-secondary" onclick="createCard()">card +</button>
      </div>
    </div>

    <div>
      <button type="button" class="btn btn-secondary columnBtn" onclick="columnCreate()">column +</button>
    </div>
  </main>
  <script>
    async function userInfo() {
      let isAdmin = await profileGet();
      console.log('isAdmin: ', isAdmin);
      if ($('#modalPforile').css('display') == 'none') {
        $('#modalPforile').show();
      }
      if (isAdmin) {
        $('#isAdminProfile').show();
        $('#isAdminDeleteBtn').show();
      } else {
        $('#isAdminProfile').hide();
        $('#isAdminDeleteBtn').hide();
      }
    }

    function closeModal() {
      if ($('#modalPforile').css('display') != 'none') {
        $('#modalPforile').hide();
      }
    }

    //마이페이지로 이동
    function myPage() {
      window.location.replace('/mypage');
    }

    //컬럼 생성 모달 온/오프
    function columnCreate() {
      if ($('#modalColumnCreate').css('display') == 'none') {
        $('#modalColumnCreate').show();
      }
    }

    function closeColumnModal() {
      if ($('#modalColumnCreate').css('display') != 'none') {
        $('#modalColumnCreate').hide();
      }
    }

    //카드 생성 모달 온/오프
    function createCard(columnId, event) {
      if ($('#modalCardCreate').css('display') == 'none') {
        $('#modalCardCreate').show();
      }

      // 클릭한 버튼의 sibling 태그를 파악
      let totalCardCount;
      console.dir(event.target);
      const siblingTag = event.target.parentElement.children;
      Object.values(siblingTag).forEach((e) => {
        if (e.className === 'cardBox') {
          // 컬럼에 든 총 카드 개수입니다.
          totalCardCount = e.children.length;
        }
      });

      // 카드 생성 Fetch
      const createCardBtn = document.querySelector('#createCardBtn');
      createCardBtn.addEventListener('click', async () => {
        //* NOTE: 컬럼 id를 획득할 방법이 있어야 함
        const name = document.querySelector('#cardTitle').value;
        const description = document.querySelector('#cardContent').value;
        const color = document.querySelector('#cardColor').value;
        const expiredDate = document.querySelector('#expiredDate').value;
        const order = totalCardCount + 1; // 기존 카드개수 + 1

        // 카드 생성 API 요청
        try {
          const response = await fetch(`/api/columns/${columnId}/cards`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              name,
              description,
              color,
              expiredDate,
              order,
            }),
          });
          const data = await response.json();
          if (response.ok) {
            console.log(data.message);
            alert('카드 생성 완료');
            // 새로고침
            location.reload();
          }
        } catch (err) {
          console.error('Error:', err);
        }
      });
    }


    function closeCardModal() {
      if ($('#modalCardCreate').css('display') != 'none') {
        $('#modalCardCreate').hide();
      }
    }

    //카드 조회 모달 온/오프
    function updateCard(columnId, cardId) {
      cardGet(columnId, cardId);
      cardUdateFunc(columnId, cardId);
      if ($('#modalCardGet').css('display') == 'none') {
        $('#modalCardGet').show();
      }
    }

    function closeCardGetModal() {
      if ($('#modalCardGet').css('display') != 'none') {
        $('#modalCardGet').hide();
      }
    }

    //댓글 작성란 버튼
    function commentBox() {
      if ($('#commentBox').css('display') == 'none') {
        $('#commentBox').show();
      }
      else if ($('#commentBox').css('display') != 'none') {
        $('#commentBox').hide();
      }
    }

    //카드 수정 버튼 클릭시 온/오프
    function cardUdateFunc(columnId, cardId) {
      document.getElementById('modalCardUpdateBtn').addEventListener('click', async function () {
        if ($('#modalCardUpdate').css('display') == 'none') {
          $('#modalCardUpdate').show();
          $('#modalCardGet').hide();
        }
        // 컬럼id와 카드id를 가져올 수 있어야 함

        try {
          const api = await fetch(`/api/columns/${columnId}/cards/${cardId}`);
          const { data } = await api.json();
          console.log(data);
          document.getElementById('cardupdateTitle').value = data.name;
          document.getElementById('cardupdateContent').value = data.description;
          document.getElementById('cardupdateColor').value = data.color;
          document.getElementById('cardupdateDate').value = data.expiredDate.split('T')[0];
          // $('#cardupdateTitle').text(data.name);
          // $('#cardupdateContent').val(data.content);
          // $('#cardupdateColor').val(data.color);
          // $('#cardupdateDate').val(data.expiredDate);

        } catch (err) {
          console.log('Error:', err);
        }

        const cardUpdateBtn = $('#cardUpdateBtn');
        cardUpdateBtn.on('click', async () => {
          // // 컬럼id와 카드id를 가져올 수 있어야 함
          const name = $('#cardupdateTitle').val();
          const description = $('#cardupdateContent').val();
          const color = $('#cardupdateColor').val();
          const expiredDate = $('#cardupdateDate').val();

          try {
            const response = await fetch(`/api/columns/${columnId}/cards/${cardId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                columnId,
                cardId,
                name,
                description,
                color,
                expiredDate,
              }),
            });
            const data = await response.json();
            console.log(data);
            alert(data.message);
          } catch (err) {
            console.error('Error:', err);
          }
        });
      });
    }

    function closeCardUpdateModal() {
      if ($('#modalCardUpdate').css('display') != 'none') {
        $('#modalCardUpdate').hide();
        $('#modalCardGet').show();
      }
    }

    //참여한 멤버 확인 버튼 온/오프
    function memberCheck() {
      if ($('.cardMembers').css('display') == 'none') {
        $('.cardMembers').show();
      }
      else if ($('.cardMembers').css('display') != 'none') {
        $('.cardMembers').hide();
      }
    }

    //보드에 참여한 멤버 확인
    function memberBoardCheck() {
      if ($('.members').css('display') == 'none') {
        $('.members').show();
      }
      else if ($('.members').css('display') != 'none') {
        $('.members').hide();
      }
    }

    // 컬럼 드래그
    const columnDragLogic = (boardId) => {
      const columnDraggables = document.querySelectorAll('.column');
      columnDraggables.forEach(draggable => {
        draggable.addEventListener("dragstart", (event) => {
          draggable.classList.add("dragging");
        });

        draggable.addEventListener("dragend", (event) => {
          draggable.classList.remove("dragging");
          const columnLists = document.querySelector('#columnLists').children;
          Object.values(columnLists).forEach(async (column, index) => {
            const columnId = column.getAttribute('data-columnId');
            try {
              const response = await fetch(`/api/boards/${boardId}/columns/${columnId}/order`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ order: index + 1 })
              });
              const data = await response.json();
            } catch (err) {
              console.error(err);
            }
          });
        });
      });

      const boardContainer = document.querySelectorAll('.columnBox');
      boardContainer.forEach(container => {
        container.addEventListener("dragover", e => {
          e.preventDefault();
          const draggable = document.querySelector(".dragging");
          if (draggable) {
            const afterElement = getDragAfterElement(container, e.clientX);
            if (afterElement === undefined) {
              container.appendChild(draggable);
            } else {
              container.insertBefore(draggable, afterElement);
            }
          } else {
            console.error("draggable element not found");
          }
        });
      });

      function getDragAfterElement(container, x) {
        const draggableElements = [
          ...container.querySelectorAll(".column:not(.dragging)"),
        ];

        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = x - box.left - box.width / 2;

            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY },
        ).element;
      }
      // columnDraggables.forEach((column) => {
      //   new Sortable(column, {
      //     group: "shared",
      //     animation: 100,
      //     ghostClass: "blue-background-class",
      //     draggable: ".column",
      //     distance: 1
      //   });
      // });
    };

    const cardDragLogic = (cardId) => {
      // 카드 드래그
      const cardDraggables = document.querySelectorAll('.card');
      const cardContainer = document.querySelectorAll('.cardBox');
      cardDraggables.forEach(draggable => {
        draggable.addEventListener("dragstart", (event) => {
          draggable.classList.add("dragging2");
          // event.target.classList.add("dragging2");
        });

        draggable.addEventListener("dragend", (event) => {
          draggable.classList.remove("dragging2");
          // event.target.classList.remove("dragging2");
        });
      });
      cardContainer.forEach(container => {
        container.addEventListener("dragover", e => {
          e.preventDefault();
          const afterElement = getDragAfterElement(container, e.clientX);
          const draggable = document.querySelector(".dragging2");
          if (afterElement === undefined) {
            container.appendChild(draggable);
          } else {
            container.insertBefore(draggable, afterElement);
          }
        });
      });
      function getDragAfterElement(container, x) {
        const draggableElements = [
          ...container.querySelectorAll(".card:not(.dragging2)"),
        ];

        return draggableElements.reduce(
          (closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = x - box.left - box.width / 2;

            if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
            } else {
              return closest;
            }
          },
          { offset: Number.NEGATIVE_INFINITY },
        ).element;
      }

      // cardDraggables.forEach((card) => {
      //   new Sortable(card, {
      //     group: "shared",
      //     animation: 100,
      //     ghostClass: "blue-background-class",
      //     draggable: ".card",
      //     distance: 1,
      //     onEnd: async (event) => {
      //       const droppedCard = event.item; // 드롭한 카드 요소
      //       const newColumn = droppedCard.closest('.column'); // 드롭된 컬럼

      //       if (newColumn) {
      //         const cardId = droppedCard.getAttribute('data-cardId');
      //         const columnId = newColumn.getAttribute('data-columnId');

      //         try {
      //           const response = await fetch(`/api/columns/${columnId}/cards/${cardId}/move`, {
      //             method: 'PUT',
      //             headers: {
      //               'Content-Type': 'application/json',
      //             },
      //             body: JSON.stringify({ columnId: columnId, newIndex: event.newIndex + 1 })
      //           });

      //           const data = await response.json();
      //         } catch (err) {
      //           console.error(err);
      //         }
      //       }
      //     }
      //   });
      // });
    };

    // 보드 정보
    $(document).ready(() => {
      // const boardId = getBoardId();
      // const columnId = getcolumnId();
      getBoard(boardId);
      getColumns(boardId);
      colorPut();
    });

    const getBoardId = () => {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('boardId');
    };
    const getcolumnId = () => {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('columnId');
    };

    const boardId = getBoardId();
    const columnId = getcolumnId();

    const getBoard = async (boardId) => {
      const response = await fetch(`/api/boards/${boardId}`);
      const boardInfo = await response.json();
      let { name, description } = boardInfo.data;
      const boardName = document.getElementById('boardName');
      const boardDesc = document.getElementById('boardDesc');
      boardName.innerText = `${name}`;
      boardDesc.innerText = `${description}`;
    };
    async function getColumns(boardId) {
      try {
        const response = await fetch(`/api/boards/${boardId}/columns`);
        const data = await response.json();
        const columns = data.columns;
        let cards;
        const columnLists = document.getElementById('columnLists');
        columnLists.innerHTML = '';

        for (const column of columns) {
          cards = await getCardsByColumnId(column.columnId);
          const cardsTags = cards.map((card) => `
                            <div draggable="true" class="card" style="background-color:${card.color};" onclick="updateCard(${column.columnId},${card.cardId})">
                              <input type="text" readonly class="form-control-plaintext" id="cardName" value="${card.name}">
                            </div>
                          `).join('');

          columnLists.innerHTML += `
        <div draggable="true" class="column m-9" data-columnId=${column.columnId}>
          <div>
            <input type="text" class="form-control" id="columnName" value="${column.name}">
            <button id="modifyColumnBtn" type="button" class="btn btn-info" onclick = "modifyColumnBtn(${column.columnId}, ${boardId}, event)">수정</button>
            <button id="dltColumnBtn" type="button" class="btn btn-danger" onclick = "dltColumnBtn(${column.columnId}, ${boardId})">삭제</button>
          </div>
          <div class="cardBox">
            ${cardsTags}
          </div>
          <button id="${column.columnId}" type="button" class="btn btn-secondary" onclick="createCard(${column.columnId}, event)">card +</button>
        </div>`;
        }
        columnDragLogic(boardId);
        cardDragLogic(cards);

      } catch (error) {
        console.error(error);
      }
    }


    // modifyColumnBtn 컬럼 수정 버튼 클릭시
    async function modifyColumnBtn(columnId, boardId, event) {
      const columnName = event.target.previousElementSibling.value;
      const api = await fetch(`/api/boards/${boardId}/columns/${columnId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: columnName }),
      });

      const { status } = await api;
      const { message } = await api.json();
      if (status == 200) {
        alert(message);
        window.location.reload();
      } else {
        alert(message);
      }
    }

    // dltColumnBtn 컬럼 삭제 버튼 클릭시
    async function dltColumnBtn(columnId, boardId) {
      const api = await fetch(`/api/boards/${boardId}/columns/${columnId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
      });

      const { status } = await api;
      const { message } = await api.json();
      if (status == 200) {
        alert(message);
        window.location.reload();
      } else {
        alert(message);
      }
    }

    async function getCardsByColumnId(columnId) {
      const response = await fetch(`/api/columns/${columnId}/cards`);
      const data = await response.json();
      const cards = data.data;
      return cards;
      // return cards.map((card) => `
      //   <div draggable="true" class="card" onclick="updateCard(${columnId},${card.cardId})">
      //     <input type="text" readonly class="form-control-plaintext" id="cardName" value="${card.name}">
      //   </div>
      // `
      // ).join(''); 
    }

    //프로필 출력 - 현재 로그인한 유저정보 API
    const profileGet = async () => {
      const api = await fetch(`/api/profile`, {
        method: 'GET',
      });
      const { status } = await api;
      const { message, data } = await api.json();
      if (status == 200) {
        const boardData = await boardProfileGet();
        const adminId = await boardAdminGet();
        let check = 0;
        //check가 1일경우 프로필모달 admin으로 출력
        //아닐경우 notAdmin으로 출력
        if (adminId.admins == data.userId) {
          check = 1;
        }
        profileHtmlFuc(data, boardData, check);
        if (check == 1) return true;
        else return false;
      } else {
        alert(message);
      }
    };

    // 프로필 출력 - 보드에 있는 유저 정보 API
    //없어서 생성함
    const boardProfileGet = async () => {
      const api = await fetch(`/api/boards/${boardId}/users`, {
        method: 'GET',
      });
      const { status } = await api;
      const { message, data } = await api.json();
      if (status == 200) {
        return data;
      } else {
        alert(message);
      }
    };

    //보드 정보 출력 - 해당 보드 정보내에있는 admin 필요
    const boardAdminGet = async () => {
      const api = await fetch(`/api/boards/${boardId}`, {
        method: 'GET',
      });
      const { status } = await api;
      const { message, data } = await api.json();
      if (status == 200) {
        return data;
      } else {
        alert(message);
      }
    };

    // 프로필 출력 - html
    const profileHtmlFuc = (data, boardData) => {

      document.getElementById(
        'nickname'
      ).innerHTML = `<input type="text" readonly class="form-control-plaintext" value="${data.nickname}">`;

      const members = document.querySelector('.members');
      members.innerHTML = '';
      for (let i in boardData) {
        //여기서 fetch에 session.user가 아닌 body나 params로 userId값을 받아 되돌려주는 라우터가 있어야
        //해당 유저의 닉네임을 받아올 수 있음. 생각해보니 회원가입시 이미지를 넣지 않음
        members.innerHTML += `<div class="col-sm-10 member">
                            <img src="../image/cat.jpg" style="width: 100px; height: 100px; border-radius: 50px;" />
                            <input type="text" readonly class="form-control-plaintext" value="${boardData[i].email}">
                        </div>`;
      }
    };

    //이메일 입력 전송
    //html에서 해당 버튼 id값 : inviteEmailBtn
    document.getElementById('inviteEmailBtn').addEventListener('click', async function () {
      const email = document.getElementById('inviteEmail').value;
      const api = await fetch(`/api/boards/${boardId}/invite`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email }),
      });
      const { status } = await api;
      const { message } = await api.json();
      if (status == 200) {
        alert(message);
        window.location.reload();
      } else {
        alert(message);
      }
    });

    //색상 저장
    async function colorPut() {
      //html에서 해당 버튼 id값 : boardColorBtn
      document.getElementById('boardColorBtn').addEventListener('click', async function () {
        const board = await boardAdminGet();
        const color = document.getElementById('backgroundColor').value;
        const api = await fetch(`/api/boards/${boardId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({color: color, name: board.name, description: board.description }),
        });
        const { status } = await api;
        const { message } = await api.json();

        console.log(status, message);
      });
    }

    //보드 삭제
    //html 해당 버튼 id값 : boardDeleteBtn
    document.getElementById('boardDeleteBtn').addEventListener('click', async function () {
      const api = await fetch(`/api/boards/${boardId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
      });
      const { status } = await api;
      const { result } = await api.json();
      if (status == 200) {
        window.location.replace('/main');
      }
    });

    // 컬럼 생성
    document.getElementById('createColumnBtn').addEventListener('click', async function createColumn() {
      // boardId 가져오기
      let boardId = new URLSearchParams(window.location.search).get('boardId');
      boardId = Number(boardId);

      // 컬럼 order
      let columns = document.querySelectorAll('.columnBox > div');
      let columnCnt = 0;
      for (let column of columns) {
        columnCnt++;
      }
      columnCnt += 1;

      const columnName = document.getElementById('columnName').value;

      try {
        const response = await fetch(`/api/boards/${boardId}/columns`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: columnName,
            order: columnCnt,
          }),
        });
        const data = await response.json();
        if (response.ok) {
          console.log(data.message);
          location.reload();
        } else {
          alert(data.message);
        }
      } catch (err) {
        console.error('Error:', err);
      }
    });

    const cardGet = async (columnId, cardId, event) => {
      const api = await fetch(`/api/columns/${columnId}/cards/${cardId}`, {
        method: 'GET',
      });
      const { status } = await api;
      const { message, data } = await api.json();
      if (status == 200) {
        getCardMembers(cardId); //cardId
        cardDetailHtml(data);
        createEmailList(boardId); //boardId
        memberAddBtn(columnId, cardId); //columnId, cardId
        userInfoGet();
        commentPost(cardId); //cardId
        commentGet(cardId); //cardId
        deleteCard(columnId, cardId); //columnId, cardId
      } else {
        alert(message);
      }
    };

    //카드 상세 보기 - html
    const cardDetailHtml = (data) => {
      console.log('cardDetail : ', data);
      document.getElementById('cardName').innerHTML = `<h5 class="modal-title">${data.name}</h5>`;
      document.getElementById(
        'cardGetTitle'
      ).innerHTML = `<input type="text" readonly class="form-control-plaintext" value="${data.name}">`;
      document.getElementById(
        'cardgetContent'
      ).innerHTML = `<textarea class="form-control-plaintext" readonly rows="3" style="min-height: 50px;">${data.description}</textarea>`;
      document.getElementById('cardgetColor').value = data.color;
      document.getElementById('expiredGetDate').value = data.expiredDate.split('T')[0];
    };

    //카드에 참여한 멤버 확인 - API
    //카드 id값으로 유저id값 get. 없어서 생성함
    const getCardMembers = async (cardId) => {
      const api = await fetch(`/api/cards/${cardId}/users`, {
        method: 'GET',
      });
      const { status } = await api;
      const { message, data } = await api.json();
      if (status == 200) {
        getHtmlCardMembers(data);
      } else {
        alert(message);
      }
    };

    //카드에 참여한 멤버 확인 - html
    const getHtmlCardMembers = (data) => {
      document.querySelector('.cardMembers').innerHTML = '';
      for (let i in data) {
        document.querySelector('.cardMembers').innerHTML += `<div class="col-sm-10 cardMember">
                                                            <img src="../image/cat.jpg" style="width: 50px; height: 50px; border-radius: 50px;" />
                                                            <input type="text" readonly class="form-control-plaintext" value="${data[i].email}">
                                                        </div>`;
      }
    };

    //멤버 초대 - 리스트부터 작성.
    const createEmailList = async (boardId) => {
      const api = await fetch(`/api/boards/${boardId}/users`, {
        method: 'GET',
      });
      const { status } = await api;
      const { message, data } = await api.json();
      if (status == 200) {
        listHtml(data);
      } else {
        alert(message);
      }
    };

    const listHtml = (data) => {
      document.getElementById('search_type').innerHTML = '';
      document.getElementById('search_type').innerHTML = '<option value="none">선택해주세요</option>';
      for (let i in data) {
        document.getElementById('search_type').innerHTML += `<option value="${data[i].email}">${data[i].email}</option>`;
      }
    };

    //멤버 추가 버튼 클릭시
    const memberAddBtn = (columnId, cardId) => {
      document.getElementById('memberAddBtn').addEventListener('click', async function () {
        const email = document.getElementById('search_type').value;
        const api = await fetch(`/api/columns/${columnId}/cards/${cardId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email }),
        });

        const { status } = await api;
        const { message } = await api.json();

        if (status == 200) {
          alert(message);
          window.location.reload();
        } else {
          alert(message);
        }
      });
    };

    //댓글 생성 -API
    //댓글 생성시 nickname은 현재 로그인한 사람의 nickname을 불러올거기 때문에 get먼저 생성
    const userInfoGet = async () => {
      const api = await fetch(`/api/profile`, {
        method: 'GET',
      });
      const { status } = await api;
      const { message, data } = await api.json();
      if (status == 200) {
        commentPostHtml(data);
      } else {
        alert(message);
      }
    };

    //댓글 작성시 nickname html
    const commentPostHtml = (data) => {
      //해당 아이디를 바로 위div로 옮김
      document.getElementById(
        'commentNickname'
      ).innerHTML = `<label for="CardNickname" class="col-sm-2 col-form-label">${data.nickname}</label>`;
    };

    //댓글 작성 후 버튼 클릭시 post - error
    const commentPost = (cardId) => {
      document.getElementById('commentBtn').addEventListener('click', async function () {
        const content = document.getElementById('cardComment').value;
        const api = await fetch(`/api/cards/${cardId}/comment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: content }),
        });
        const { status } = await api;
        const { message } = await api.json();
        console.log(status, message);
        if (status == 200) {
          alert(message);
          window.location.reload();
        } else {
          alert(message);
        }
      });
    };

    //댓글 출력 api - error
    const commentGet = async (cardId) => {
      const api = await fetch(`/api/cards/${cardId}/comment`, {
        method: 'GET',
      });

      const { status } = await api;
      const { message, data } = await api.json();
      if (status == 200) {
        console.log(data);
        getCommentHtml(data);
      } else {
        alert(message);
      }
    };

    const getCommentHtml = (data) => {
      document.getElementById('commentGetBox').innerHTML = '';
      for (let i in data) {
        document.getElementById(
          'commentGetBox'
        ).innerHTML += `<label for="CardNickname" class="col-sm-2 col-form-label">${data[i].User.nickname}</label>
                            <div class="col-sm-10">
                              <textarea class="form-control-plaintext" readonly id="cardContent" rows="3" style="min-height: 50px;">${data[i].content}</textarea>
                              </div>`;
      }
    };

    //카드 삭제 - api
    const deleteCard = (columnId, cardId) => {
      //삭제 버튼 클릭시
      document.getElementById('deleteCardBtn').addEventListener('click', async function () {
        const api = await fetch(`/api/columns/${columnId}/cards/${cardId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
        });
        const { status } = await api;
        if (status == 200) {
          window.location.reload();
        }
      });
    };
  </script>
</body>

</html>